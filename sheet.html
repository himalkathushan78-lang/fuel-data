<!DOCTYPE html>
<html>
<head>
    <title>Fuel Requests Dashboard</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background-color: #f4f7f6; 
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            background: white;
        }

        th, td {
            border: 1px solid #dfe6e9;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #3498db;
            color: white;
            text-transform: uppercase;
            font-size: 13px;
        }

        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }

        .img-preview { 
            width: 80px; 
            height: 60px; 
            object-fit: cover;
            border-radius: 5px; 
            cursor: pointer;
            border: 1px solid #ddd;
            display: block;
        }

        .chart-section {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            background: #fdfdfd;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }

        iframe {
            border: none;
            max-width: 100%;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>Fuel Request List</h2>

    <table id="dataTable">
        <thead>
            <tr>
                <th>Driver_ID</th>
                <th>Lorry Number</th>
                <th>Mileage</th>
                <th>Required Liters</th>
                <th>Date & Time</th>
                <th>Receipt Image</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div class="chart-section">
        <h3>Data Analysis Visualization</h3>
        <iframe id="fuelIframe" width="600" height="371" seamless frameborder="0" scrolling="no" src=""></iframe>
    </div>
</div>

<script>
    // 1. FETCH TABLE DATA AND IMAGES
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwz5DFBa-7n6e-nr1bhY3Eq531cT-AplEGvAmtGKY8JP8fDf_CvYHJhtC2oSzy0bmWC/exec";

    fetch(scriptUrl)
    .then(res => res.json())
    .then(data => {
        let tableBody = document.querySelector("#dataTable tbody");

        // Assuming row 0 is headers, we skip it with slice(1)
        data.slice(1).forEach(row => {
            let tr = document.createElement("tr");

            row.forEach((cell, index) => {
                let td = document.createElement("td");

                // Check if this is the 6th column (index 5) containing the Drive link
                if (index === 5 && cell && cell.toString().includes("drive.google.com")) {
                    
                    // Extract ID using regex
                    const idMatch = cell.match(/[-\w]{25,}/);
                    if (idMatch) {
                        const fileId = idMatch[0];
                        let img = document.createElement("img");
                        
                        // Using the thumbnail-specific URL which is more reliable for embedding
                        img.src = `https://lh3.googleusercontent.com/d/${fileId}=w200`;
                        img.className = "img-preview";
                        img.alt = "View Receipt";
                        img.setAttribute("referrerpolicy", "no-referrer");

                        // Clicking image opens the original Google Drive link
                        img.onclick = () => window.open(cell, '_blank');
                        td.appendChild(img);
                    } else {
                        td.textContent = "No ID found";
                    }
                } else {
                    td.textContent = cell;
                }
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    })
    .catch(error => console.error('Error fetching data:', error));

    // 2. LOAD CHART WITH CACHE BUSTER
    const chartBaseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAbDefrUQsiI2GAHOq1RltbF5mcgzySIddx1X1OSx5JzKYm8bCnd3o8zQQdVPrQuuD8xoDMLSVmCZ7/pubchart?oid=675034914&format=interactive";
    const cacheBuster = "&t=" + new Date().getTime();
    document.getElementById('fuelIframe').src = chartBaseUrl + cacheBuster;
</script>

</body>
</html>